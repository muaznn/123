<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Handle Maintenance Request</title>
    <link rel="stylesheet" href="style4.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"> -->
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap");

      /* Enhanced pagination styles */
      #pagination button {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }
      #pagination button:hover:not(:disabled) {
        background-color: #d0d0d0;
      }
      #pagination button:disabled {
        cursor: default;
        opacity: 0.6;
      }
      #pagination button.active,
      #pagination button[disabled] {
        font-weight: bold;
        background-color: #007bff;
        color: white;
        border-color: #007bff;
      }

      /* Style for items per page dropdown */
      #items-per-page-container {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: #555;
        gap: 5px;
      }
      #items-per-page-select {
        padding: 3px 6px;
        font-size: 14px;
        border-radius: 4px;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      #items-per-page-select:hover {
        border-color: #007bff;
      }
    </style>
  </head>
  <body>
    <!-- Placeholder untuk sidebar -->
    <div id="sidebar-placeholder"></div>

    <div class="main-content">
      <header class="header-title">
        <div class="header-group">
          <span class="admin-text"
            >Admin <i class="fas fa-chevron-down text-base"></i
          ></span>
          <i class="far fa-bell cursor-pointer"></i>
          <i class="far fa-user-circle cursor-pointer"></i>
        </div>
      </header>

      <!-- cards of most used/service  -->
      <div class="cards" style="margin: 10px 10px 0px 0px;">
        <div class="card" style="border-radius: 20px;">
          <h3>Most Used :</h3>
          <p id="most-used-item">Glove</p>
        </div>
        <div class="card" style="border-radius: 20px;">
          <h3>Most Serviced :</h3>
          <p id="most-serviced-item">Treadmill</p>
        </div>
        <div style="margin-left:auto;">
          <a href="reportGenerate.html"><button class="btn back">Generate Report</button></a>
        </div>
      </div>

      <!-- report logs table -->
      <div class="table-container">
        <div class="table-title">
          <span class="handle-maintenance-title">Report Logs</span>
          <div class="search-container">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="search-input"
              placeholder="Search"
              class="search-input"
            />
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>No.</th>
              <th>Report Type</th>
              <th>Generated By</th>
              <th>
                Generated At
                <i
                  id="sort-generatedAt"
                  class="fas fa-sort cursor-pointer"
                  style="margin-left: 5px;"
                ></i>
              </th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div
          class="table-footer"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
          "
        >
          <div id="items-per-page-container">
            <label for="items-per-page-select">Showing</label>
            <select id="items-per-page-select" title="Select items per page">
              <option value="5">5</option>
              <option value="10" selected>10</option>
              <option value="20">20</option>
              <option value="all">All</option>
            </select>
            <span>entries</span>
          </div>
          <div id="pagination" style="display: flex; gap: 5px"></div>
        </div>
      </div>
    </div>
    <script>
      // Wrap all JS code inside DOMContentLoaded to ensure elements are loaded before script runs
      document.addEventListener("DOMContentLoaded", function () {
        let currentPage = 1;
        let itemsPerPage = 10;
        let reportData = [];
        let filteredReportData = [];
        let currentSortOrder = "desc"; // default sort order

        const tbody = document.querySelector("tbody");
        const paginationElem = document.getElementById("pagination");
        const searchInput = document.getElementById("search-input");
        const sortIcon = document.getElementById("sort-generatedAt");
        const itemsPerPageSelect = document.getElementById("items-per-page-select");

        function attachViewListeners() {
          document.querySelectorAll(".fa.view").forEach((icon) => {
            icon.addEventListener("click", function () {
              const reportID = this.getAttribute("data-requestid");
              const row = this.closest("tr");
              const reportType = row
                .querySelector("td:nth-child(2)")
                .textContent.trim()
                .toLowerCase();
              const startDate = row.getAttribute("data-startdate");
              const endDate = row.getAttribute("data-enddate");
              if (reportType === "usage") {
                window.location.href = `reportUsage.html?reportID=${reportID}`;
              } else if (reportType === "maintenance") {
                if (startDate && endDate) {
                  window.location.href = `reportMaintenance.html?reportID=${reportID}&startDate=${encodeURIComponent(
                    startDate
                  )}&endDate=${encodeURIComponent(endDate)}`;
                } else {
                  window.location.href = `reportMaintenance.html?reportID=${reportID}`;
                }
              } else {
                window.location.href = `reportMaintenance.html?reportID=${reportID}`;
              }
            });
          });
        }

        function updateTable() {
          const dataToRender =
            filteredReportData.length || filteredReportData.length === 0
              ? filteredReportData
              : reportData;
          const totalItems = dataToRender.length;
          const totalPages =
            itemsPerPage === totalItems ? 1 : Math.ceil(totalItems / itemsPerPage);

          // Calculate start and end index for current page
          let startIndex = 0;
          let endIndex = totalItems;
          if (itemsPerPage !== totalItems) {
            startIndex = (currentPage - 1) * itemsPerPage;
            endIndex = Math.min(startIndex + itemsPerPage, totalItems);
          }

          // Render table rows for current page
          tbody.innerHTML = "";
          for (let i = startIndex; i < endIndex; i++) {
            const row = dataToRender[i];
            tbody.innerHTML += `
              <tr data-row-id="${row.reportID}" data-startdate="${row.dateStart}" data-enddate="${row.dateEnd}">
                <td>${i + 1}.</td>
                <td>${row.reportType}</td>
                <td>${row.userName}</td>
                <td>${row.generatedAt}</td>
                <td class="action-buttons">
                  <i class="fa view fa-eye" aria-hidden="true" data-requestid="${row.reportID}"></i>
                </td>
              </tr>
            `;
          }

          attachViewListeners();

          // Update data count display - now handled by dropdown label, so no text update here

          // Render pagination controls
          paginationElem.innerHTML = "";

          // If itemsPerPage is "all", disable pagination controls
          if (itemsPerPage === totalItems) {
            // No pagination needed
            return;
          }

          // Previous button
          const prevBtn = document.createElement("button");
          prevBtn.textContent = "Previous";
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              currentPage--;
              updateTable();
            }
          });
          paginationElem.appendChild(prevBtn);

          // Page numbers
          for (let p = 1; p <= totalPages; p++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = p;
            if (p === currentPage) {
              pageBtn.disabled = true;
              pageBtn.classList.add("active");
            }
            pageBtn.addEventListener("click", () => {
              currentPage = p;
              updateTable();
            });
            paginationElem.appendChild(pageBtn);
          }

          // Next button
          const nextBtn = document.createElement("button");
          nextBtn.textContent = "Next";
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
              currentPage++;
              updateTable();
            }
          });
          paginationElem.appendChild(nextBtn);
        }

      // Fetch data and initialize
      fetch("get_report.php")
        .then((response) => response.json())
        .then((data) => {
          reportData = data;

          // Initial sort descending and render
          reportData.sort(
            (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
          );
          filteredReportData = reportData;
          updateTable();
        })
        .catch((error) => console.error("Error loading requests:", error));

      // Fetch most used and most serviced items and update cards
      fetch("get_most_used_serviced.php")
        .then((response) => response.json())
        .then((data) => {
          if (data.mostUsed) {
            document.getElementById("most-used-item").textContent = data.mostUsed;
          }
          if (data.mostServiced) {
            document.getElementById("most-serviced-item").textContent = data.mostServiced;
          }
        })
        .catch((error) => console.error("Error loading most used/serviced items:", error));

        // Search input event
        searchInput.addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();

          // Filter reportData based on search term
          filteredReportData = reportData.filter((row) => {
            return (
              row.reportType.toLowerCase().includes(searchTerm) ||
              row.userName.toLowerCase().includes(searchTerm) ||
              row.generatedAt.toLowerCase().includes(searchTerm)
            );
          });

          currentPage = 1; // Reset to first page on search
          updateTable();
        });

        // Sort icon click event
        sortIcon.addEventListener("click", () => {
          if (currentSortOrder === "desc") {
            currentSortOrder = "asc";
            reportData.sort(
              (a, b) => new Date(a.generatedAt) - new Date(b.generatedAt)
            );
            sortIcon.classList.remove("fa-sort");
            sortIcon.classList.remove("fa-sort-down");
            sortIcon.classList.add("fa-sort-up");
          } else {
            currentSortOrder = "desc";
            reportData.sort(
              (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
            );
            sortIcon.classList.remove("fa-sort");
            sortIcon.classList.remove("fa-sort-up");
            sortIcon.classList.add("fa-sort-down");
          }
          updateTable();
        });

        // Items per page dropdown change event
        itemsPerPageSelect.addEventListener("change", function () {
          const val = this.value;
          if (val === "all") {
            itemsPerPage = filteredReportData.length || reportData.length;
          } else {
            itemsPerPage = parseInt(val, 10);
          }
          currentPage = 1;
          updateTable();
        });
      });
    </script>
    <script>
      // sidebar
      fetch("sidebar.html")
        .then((response) => response.text())
        .then((data) => {
          document.getElementById("sidebar-placeholder").innerHTML = data;
        });

      // Fetch data request dari server
      fetch("get_report.php")
        .then((response) => response.json())
        .then((data) => {
          const tbody = document.querySelector("tbody");
          tbody.innerHTML = ""; // Kosongkan jadual

          let currentSortOrder = "desc"; // default sort order
          let reportData = data;

          function renderTable(dataToRender) {
            tbody.innerHTML = "";
            dataToRender.forEach((row, index) => {
              tbody.innerHTML += `
                <tr data-row-id="${row.reportID}" data-startdate="${row.dateStart}" data-enddate="${row.dateEnd}">
                  <td>${index + 1}.</td>
                  <td>${row.reportType}</td>
                  <td>${row.userName}</td>
                  <td>${row.generatedAt}</td>
                  <td class="action-buttons">
                    <i class="fa view fa-eye" aria-hidden="true" data-requestid="${row.reportID}"></i>
                    <!-- Removed edit icon as per user request -->
                    <!-- removed delete icon -->
                  </td>
                </tr>
              `;
            });
            attachViewListeners();
          }

          function attachViewListeners() {
            document.querySelectorAll(".fa.view").forEach((icon) => {
              icon.addEventListener("click", function () {
                const reportID = this.getAttribute("data-requestid");
                const row = this.closest("tr");
                const reportType = row
                  .querySelector("td:nth-child(2)")
                  .textContent.trim()
                  .toLowerCase();
                const startDate = row.getAttribute("data-startdate");
                const endDate = row.getAttribute("data-enddate");
                if (reportType === "usage") {
                  window.location.href = `reportUsage.html?reportID=${reportID}`;
                } else if (reportType === "maintenance") {
                  if (startDate && endDate) {
                    window.location.href = `reportMaintenance.html?reportID=${reportID}&startDate=${encodeURIComponent(
                      startDate
                    )}&endDate=${encodeURIComponent(endDate)}`;
                  } else {
                    window.location.href = `reportMaintenance.html?reportID=${reportID}`;
                  }
                } else {
                  window.location.href = `reportMaintenance.html?reportID=${reportID}`;
                }
              });
            });
          }

          // Initial sort descending and render
          reportData.sort(
            (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
          );
          renderTable(reportData);

          // Sort icon click handler
          document
            .getElementById("sort-generatedAt")
            .addEventListener("click", () => {
              if (currentSortOrder === "desc") {
                currentSortOrder = "asc";
                reportData.sort(
                  (a, b) => new Date(a.generatedAt) - new Date(b.generatedAt)
                );
                document
                  .getElementById("sort-generatedAt")
                  .classList.remove("fa-sort");
                document
                  .getElementById("sort-generatedAt")
                  .classList.remove("fa-sort-down");
                document
                  .getElementById("sort-generatedAt")
                  .classList.add("fa-sort-up");
              } else {
                currentSortOrder = "desc";
                reportData.sort(
                  (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
                );
                document
                  .getElementById("sort-generatedAt")
                  .classList.remove("fa-sort");
                document
                  .getElementById("sort-generatedAt")
                  .classList.remove("fa-sort-up");
                document
                  .getElementById("sort-generatedAt")
                  .classList.add("fa-sort-down");
              }
              renderTable(reportData);
            });

          // Initialize icon to descending
          document
            .getElementById("sort-generatedAt")
            .classList.add("fa-sort-down");

          // Attach view listeners for initial render
          attachViewListeners();
        })
        .catch((error) => console.error("Error loading requests:", error));

      document
        .getElementById("search-input")
        .addEventListener("input", function () {
          const searchTerm = this.value.toLowerCase();

          // Filter reportData based on search term
          const filteredData = reportData.filter((row) => {
            return (
              row.reportType.toLowerCase().includes(searchTerm) ||
              row.userName.toLowerCase().includes(searchTerm) ||
              row.generatedAt.toLowerCase().includes(searchTerm)
            );
          });

          currentPage = 1; // Reset to first page on search
          filteredReportData = filteredData;
          updateTable();
        });

      let currentPage = 1;
      let itemsPerPage = 10;
      // Removed duplicate declaration of filteredReportData here

      function updateTable() {
        const tbody = document.querySelector("tbody");
        const dataCountElem = document.getElementById("data-count");
        const paginationElem = document.getElementById("pagination");

        const dataToRender =
          filteredReportData.length || filteredReportData.length === 0
            ? filteredReportData
            : reportData;
        const totalItems = dataToRender.length;
        const totalPages =
          itemsPerPage === totalItems ? 1 : Math.ceil(totalItems / itemsPerPage);

        // Calculate start and end index for current page
        let startIndex = 0;
        let endIndex = totalItems;
        if (itemsPerPage !== totalItems) {
          startIndex = (currentPage - 1) * itemsPerPage;
          endIndex = Math.min(startIndex + itemsPerPage, totalItems);
        }

        // Render table rows for current page
        tbody.innerHTML = "";
        for (let i = startIndex; i < endIndex; i++) {
          const row = dataToRender[i];
          tbody.innerHTML += `
            <tr data-row-id="${row.reportID}" data-startdate="${row.dateStart}" data-enddate="${row.dateEnd}">
              <td>${i + 1}.</td>
              <td>${row.reportType}</td>
              <td>${row.userName}</td>
              <td>${row.generatedAt}</td>
              <td class="action-buttons">
                <i class="fa view fa-eye" aria-hidden="true" data-requestid="${row.reportID}"></i>
              </td>
            </tr>
          `;
        }

        attachViewListeners();

        // Update data count display - now handled by dropdown label, so no text update here

        // Render pagination controls
        paginationElem.innerHTML = "";

        // If itemsPerPage is "all", disable pagination controls
        if (itemsPerPage === totalItems) {
          // No pagination needed
          return;
        }

        // Previous button
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "Previous";
        prevBtn.disabled = currentPage === 1;
        prevBtn.addEventListener("click", () => {
          if (currentPage > 1) {
            currentPage--;
            updateTable();
          }
        });
        paginationElem.appendChild(prevBtn);

        // Page numbers
        for (let p = 1; p <= totalPages; p++) {
          const pageBtn = document.createElement("button");
          pageBtn.textContent = p;
          if (p === currentPage) {
            pageBtn.disabled = true;
            pageBtn.classList.add("active");
          }
          pageBtn.addEventListener("click", () => {
            currentPage = p;
            updateTable();
          });
          paginationElem.appendChild(pageBtn);
        }

        // Next button
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "Next";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.addEventListener("click", () => {
          if (currentPage < totalPages) {
            currentPage++;
            updateTable();
          }
        });
        paginationElem.appendChild(nextBtn);
      }

      // Initial setup
      let currentSortOrder = "desc"; // default sort order
      let reportData = [];
      let filteredReportData = [];

      fetch("get_report.php")
        .then((response) => response.json())
        .then((data) => {
          reportData = data;

          // Initial sort descending and render
          reportData.sort(
            (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
          );
          updateTable();

          // Sort icon click handler
          document.getElementById("sort-generatedAt").addEventListener("click", () => {
            if (currentSortOrder === "desc") {
              currentSortOrder = "asc";
              reportData.sort(
                (a, b) => new Date(a.generatedAt) - new Date(b.generatedAt)
              );
              document.getElementById("sort-generatedAt").classList.remove("fa-sort");
              document.getElementById("sort-generatedAt").classList.remove("fa-sort-down");
              document.getElementById("sort-generatedAt").classList.add("fa-sort-up");
            } else {
              currentSortOrder = "desc";
              reportData.sort(
                (a, b) => new Date(b.generatedAt) - new Date(a.generatedAt)
              );
              document.getElementById("sort-generatedAt").classList.remove("fa-sort");
              document.getElementById("sort-generatedAt").classList.remove("fa-sort-up");
              document.getElementById("sort-generatedAt").classList.add("fa-sort-down");
            }
            updateTable();
          });
        })
        .catch((error) => console.error("Error loading requests:", error));
    </script>
    <!-- Bootstrap JS (optional for modal/alert) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script for logic -->
    <script>
      const reportType = document.getElementById("reportType");
      const filterStatus = document.getElementById("filterStatus");
      const startDate = document.getElementById("startDate");
      const endDate = document.getElementById("endDate");
      const form = document.getElementById("reportForm");

      // Enable/disable filters based on report type
      reportType.addEventListener("change", function () {
        const type = this.value;
        if (type === "usage") {
          filterStatus.disabled = true;
          filterStatus.checked = false;
        } else if (type === "maintenance") {
          filterStatus.disabled = false;
        }
      });

      // Ensure end date >= start date
      startDate.addEventListener("change", function () {
        endDate.min = this.value;
        if (endDate.value < this.value) {
          endDate.value = "";
        }
      });

      // On submit
      form.addEventListener("submit", function (e) {
        e.preventDefault();

        if (!reportType.value || !startDate.value || !endDate.value) {
          alert("Please fill in all fields.");
          return;
        }

        if (endDate.value < startDate.value) {
          alert("End date cannot be before start date.");
          return;
        }

        // Confirmation message
        alert(
          `Report generated successfully!\nType: ${
            reportType.options[reportType.selectedIndex].text
          }\nDate Range: ${startDate.value} to ${endDate.value}`
        );
      });
    </script>
  </body>
</html>
